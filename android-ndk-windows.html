<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Android NDK programming</title>
<meta name="description" content="Plain C Android APKs with NDK">
<meta name="viewport" content="width=devide-width, initial-scale=1">
<link rel="apple-touch-icon" href="icon.png">
<link rel="stylesheet" href="unstyle.css">
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="print.css" media="print">
</head>
<body>

<div id="pages" class="clearfix">

<div>

  <h1 id="title"><a href="#title"></a>Android NDK programming in C (Windows)</h1>

  <p>This text describes compilation of C code for Android with Windows. Starting from API level 9 Android applications can be compiled without using any Java.</p>

  <p>The Android NDK bundle includes the toolchains for building the binaries. The Android SDK bundle includes the SDK manager and the AVD manager; the SDK manager downloads the APK tools and the Android platform JARs. The Android IDE bundle includes a compatible Java Development Kit (OpenJDK 1.8) and a signature key tool. The project directory structure is shown in <a href="#figure-1">figure 1</a> below.</p>

  <figure aria-labelledby="figure-1-caption" id="figure-1">
<pre role="img"
>.                         ./jdk                      ./sdk/platforms
├─ jdk ─ ...              ├─ bin                     └─ android-21
├─ sdk ─ ...              │  ├─ java.exe                ├─ android.jar
├─ ndk ─ ...              │  ├─ keytool.exe             └─ ...
├─ build                  │  └─ ...
│  └─ lib                 ├─ lib ─ ...               ./ndk
│     ├─ armeabi-v7a      └─ ...                     ├─ platforms
│     ├─ arm64-v8a                                   │  ├─ android-21
│     ├─ x86              ./sdk                      │  │  ├─ arch-arm/usr/lib ─ ...
│     └─ x86_64           ├─ tools                   │  │  ├─ arch-arm64/usr/lib ─ ...
├─ src ─ ...              │  ├─ bin                  │  │  ├─ arch-x86/usr/lib ─ ...
├─ assets                 │  │  ├─ sdkmanager.bat    │  │  └─ arch-x86_64/usr/lib ─ ...
├─ res                    │  │  └─ avdmanager.bat    │  └─ ...
│  ├─ drawable ─ ...      │  ├─ lib ─ ...            ├─ sysroot
│  ├─ mipmap-&lt;DPI&gt;        │  └─ ...                  │  └─ usr
│  │  └─ ic_launcher.png  ├─ platforms ─ ...         │     ├─ include ─ ...
│  └─ values              ├─ platform-tools          │     └─ lib
│     ├─ strings.xml      │  ├─ adb.exe              │        ├─ arm-linux-androideabi
│     └─ styles.xml       │  └─ ...                  │        ├─ aarch64-linux-android
├─ AndroidManifest.xml    ├─ build-tools             │        ├─ i686-linux-android
├─ build_armeabi-v7a.bat  │  └─ 29.0.1               │        └─ x86_64-linux-android
├─ build_arm64-v8a.bat    │     ├─ lib               ├─ toolchains
├─ build_x86.bat          │     │  ├─ apksigner.jar  │  ├─ llvm/prebuilt/windows-x86_64/bin/clang.exe
├─ build_x86_64.bat       │     │  └─ ...            │  ├─ arm-linux-androideabi-4.9 ─ ...
├─ keystore.jks           │     ├─ apksigner.bat     │  ├─ aarch64-linux-android-4.9 ─ ...
├─ sdkmanager.bat         │     ├─ aapt.exe          │  ├─ x86-4.9 ─ ...
└─ ...                    │     └─ zipalign.exe      │  ├─ x86_64-4.9 ─ ...
                          └─ ...                     │  └─ ...
                                                     └─ ...</pre>
  <figcaption id="figure-1-caption">Figure 1: Project directory structure for APK tools and source files. The SDK's build tools version is 29.0.1, the Android API level is 21, and the NDK's clang compiler is for Windows 64-bit. Multiple <code>mipmap-&lt;DPI&gt;</code> directories are added to provide launch icon resolutions for different pixel densitites.</figcaption>
  </figure>

  <p>The Android Studio bundle has its JDK in <code>jre/jre</code>. Only this directory's contents (i.e. <code>bin</code> and <code>lib</code>) are copied to the project's <code>jdk</code> directory. Also note that the <code>platforms</code>, <code>platform-tools</code>, and <code>build-tools</code> directories in <code>sdk</code> are created by the SDK manager and the project root files are created later.</p>

  <p>The <code>sdkmanager.bat</code> script inside the project root is based on <code>sdk/sdkmanager.bat</code>, but it manually sets the path to <code>jdk/bin/java.exe</code> as shown below.</p>

  <div class="code"><pre><code
>@echo off
setlocal

set JAVA_EXE=jdk\bin\java.exe
call %JAVA_EXE% -Dcom.android.sdklib.toolsdir=sdk\tools -classpath sdk\tools\lib\* ^
  com.android.sdklib.tool.sdkmanager.SdkManagerCli %*

endlocal</code></pre>
  </div>

  <p>To list the available packages run the <code>sdkmanager.bat</code> script at project's root. Output is redirected to a text file for convenience.</p>

  <div class="code"><pre><code
>sdkmanager --list > packages.txt</code></pre>
  </div>
    
</div>


<div>

  <p>Download the tools and platforms with the <code>sdkmanager.bat</code> script as shown. The version is part of the package name. Enter <code>y</code> when prompted to accept the license agreement.</p>

  <div class="code"><pre><code
>sdkmanager "platform-tools" "platforms;android-21" "build-tools;29.0.1"</code></pre>
  </div>

  <h2 id="1-1"><a href="#1-1"></a>Compiling an APK</h2>

  <p>The APK will contain:</p>

  <ul>
    <li>the compiled shared libraries for the supported architectures.</li>
    <li>the platform JAR-file <code>android.jar</code> from the SDK.</li>
    <li>the <code>AndroidManifest.xml</code> file, which specifies the application's run-time requirements.</li>
    <li>the <code>res</code> directory, containing XML configuration files and the launch icon at different resolutions.</li>
    <li>the <code>assets</code> directory, containing files accessible with functions from <code>asset_manager.h</code>.</li>
  </ul>

  <p>An APK is created with <code>aapt.exe</code> (Android Asset Packaging Tool) along with the resources and then it needs to be cryptographically signed to be installed. The <code>keytool.exe</code> program generates a key store and a key used for signing the APK with <code>apksigner.jar</code>.</p>

  <p>Use <code>keytool.exe</code> to generate a key store file with a key pair entry for signing the APK. The public key is wrapped into an X.509 v3 self-signed certificate. Below both passwords are <code>password</code>, the key pair is called <code>projectkey</code>. The key certificate is valid for 9125 days and its fields are set by <code>-dname</code>.</p>

  <div class="code"><pre><code
>set KS_PASSWORD=password
set KEY_PASSWORD=password
set KEYTOOL=jdk\bin\keytool.exe
call %KEYTOOL% -genkeypair -keystore keystore.jks ^
    -keyalg RSA -keysize 2048 -validity 9125 -storetype jks ^
    -storepass %KS_PASSWORD% -keypass %KEY_PASSWORD% -alias projectkey ^
    -dname "CN=Name, OU=App, O=Organization, L=City, ST=Province, C=SE"</code></pre>
  </div>

  <p>If <code>-dname</code> isn't specified <code>keytool.exe</code> prompts for the values. <code>CN</code> is common name, <code>OU</code> is organization unit, <code>O</code> is organization name, <code>L</code> is city or locality, <code>S</code> is state or province, and <code>C</code> is two-letter country code.</p>

  <p>The certificate can be exported to a <code>pem</code> file using option <code>-exportcert</code>.</p>

  <div class="code"><pre><code
>call %KEY_TOOL% -exportcert -rfc -file certificate.pem -keystore keystore.jks -alias projectkey</code></pre>
  </div>

  <p>Create the APK as <code>unsigned.unaligned.apk</code> using <code>aapt.exe</code>. <code>--debug-mode</code> adds <code>android:debuggable="true"</code> on the application node in the <code>AndroidManifest.xml</code> file.</p>

  <div class="code"><pre><code
>set AAPT=sdk\build-tools\29.0.1\aapt.exe
call %AAPT% package ^
    --debug-mode -f -0 tga ^
    -M AndroidManifest.xml -A assets -S res -I sdk\platforms\android-21\android.jar ^
    -F unsigned.unaligned.apk ^
    build</code></pre>
  </div>

  <div class="note">
    Check which files are compressed by <code>aapt</code> with the verbose output option <code>-v</code>. The <code>-0 &lt;EXTENSION&gt;</code> option disables compression for the file extension. <code>AAsset_openFileDescriptor</code> in <code>asset_manager.h</code> fails on compressed files and files over 1MB can't be extracted by the asset manager.
  </div>

  <p>Run <code>zipalign.exe</code> to align assets to 4 byte boundaries and name the output <code>unsigned.apk</code>.</p>

  <div class="code"><pre><code
>set ZIPALIGN=sdk\build-tools\29.0.1\zipalign.exe
call %ZIPALIGN% -p -f 4 unsigned.unaligned.apk unsigned.apk
</code></pre>
  </div>

</div>

<div>

  <p>Sign the APK using <code>apksigner.jar</code>. This outputs <code>app.apk</code> containing the directory <code>META-INF</code> which includes signature data files. The following script is used instead of the SDK's <code>apksigner.bat</code> file in order to explicitly set the path to <code>java.exe</code>.</p>

  <div class="code"><pre><code
>set JAVAEXE=jdk\bin\java.exe
set APKSIGNER=sdk\build-tools\29.0.1\lib\apksigner.jar
call %JAVAEXE% -jar %APKSIGNER% sign --in unsigned.apk --out app.apk ^
    --ks keystore.jks --ks-type jks --ks-key-alias projectkey --ks-pass pass:%KS_PASSWORD%
</code></pre>
  </div>

  <div class="note">
    If the JDK's <code>jarsigner.exe</code> tool is used instead <code>apksigner.jar</code> from the SDK, then <code>zipalign.exe</code> must be used after signing, not before.
  </div>

  <p>The <code>AndroidManifest.xml</code> file is shown below.</p>

  <div class="code"><pre><code
>&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;manifest xmlns:android="http://schemas.android.com/apk/res/android"
      package="io.github.linjan2.myapp"
      android:versionCode="1" android:versionName="1.0.0"&gt;

  &lt;uses-sdk android:minSdkVersion="21" android:targetSdkVersion="21" /&gt;
  &lt;uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" /&gt;
  &lt;uses-feature android:glEsVersion="00020000" /&gt;
  &lt;uses-feature android:name="android.hardware.screen.landscape" /&gt;
  &lt;uses-feature android:name="android.hardware.screen.portrait" /&gt;

  &lt;application android:label="@string/app_name" android:theme="@style/mytheme"
    android:icon="@mipmap/ic_launcher" android:hasCode="false"&gt;

    &lt;activity android:name="android.app.NativeActivity"
      android:configChanges="orientation|keyboard|keyboardHidden|screenSize"&gt;
      &lt;meta-data android:name="android.app.lib_name" android:value="mylib" /&gt;

      &lt;intent-filter&gt;
        &lt;action android:name="android.intent.action.MAIN" /&gt;
        &lt;category android:name="android.intent.category.LAUNCHER" /&gt;
      &lt;/intent-filter&gt;
    &lt;/activity&gt;
  &lt;/application&gt;
&lt;/manifest&gt;</code></pre>
  </div>

  <p>The manifest values have the following semantics:</p>

  <ul>
    <li>The package name is the name of the installation directory. A GitHub repository pages domain ensures uniqueness; URL <code>linjan2.github.io/myapp</code> gives <code>io.github.linjan2.myapp</code>.</li>
    <li><code>versionCode</code> is incremented when upgrading the application so users can update their installation.</li>
    <li><code>versionName</code> is the visible version string.</li>
    <li>The application supports <code>minSdkVersion</code> and up, and has been tested up to <code>targetSdkVersion</code>.</li>
    <li><code>&lt;uses-permission&gt;</code> adds access to hardware APIs like external storage and network interfaces.</li>
    <li><code>glEsVersion="00020000"</code> requires OpenGL ES 2.0 support. Use <code>0x00030002</code> for version 3.2.</li>
    <li><code>label="@string/app_name"</code> sets the application's name to the content of the element named <code>app_name</code> declared in <code>res/values/strings.xml</code>.</li>
    <li><code>theme="@styles/mytheme"</code> applies the styles of the element named <code>mytheme</code> in <code>res/values/styles.xml</code>. The styles remove the action bar and configure the status and navigation bars.</li>
    <li><code>icon="@mipmap/ic_launcher"</code> sets the launch icon to <code>res/mipmap-&lt;DPI&gt;/ic_launcher.png</code>. The system selects the correct pixel density.</li>
    <li><code>hasCode="false"</code> is needed to launch the native activity without Java code.</li>
    <li>The activity is the <code>android.app.NativeActivity</code> class, which is a system built-in class.</li>
    <li>The application will manually handle the configuration changes in <code>configChanges</code>.</li>
    <li>The <code>lib_name</code> meta data value is the library name (<code>lib&lt;NAME&gt;.so</code>) without <code>lib</code> and <code>.so</code>.</li>
    <li>The intent filters are needed for launching the application into the activity.</li>
  </ul>

</div>

<div>

  <p>The <code>strings.xml</code> file is shown below.</p>

  <div class="code"><pre><code
>&lt;resources&gt;
    &lt;string name="app_name"&gt;MyApp&lt;/string&gt;
&lt;/resources&gt;</code></pre>
  </div>

  <p>The <code>styles.xml</code> file is shown below. The action bar is removed and the status and navigation bars are set to be automatically drawn by the system. The color attributes may show in the window manager.</p>


  <div class="code"><pre><code
>&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;resources&gt;
  &lt;style name="mytheme"&gt;
    &lt;item name="android:windowActionBar"&gt;false&lt;/item&gt;
    &lt;item name="android:windowNoTitle"&gt;true&lt;/item&gt;
    &lt;item name="android:windowDrawsSystemBarBackgrounds"&gt;false&lt;/item&gt;
    &lt;item name="android:windowTranslucentStatus"&gt;false&lt;/item&gt;
    &lt;item name="android:windowTranslucentNavigation"&gt;false&lt;/item&gt;
    &lt;item name="android:colorPrimary"&gt;#222427&lt;/item&gt;
    &lt;item name="android:colorPrimaryDark"&gt;#222427&lt;/item&gt;
  &lt;/style&gt;
&lt;/resources&gt;</code></pre>
  </div>

  <div class="note">
    The system bars are drawn over the EGL surface when the window isn't in fullscreen mode. The OpenGL viewport and scissor box should use the content rectangle instead of the full window.
  </div>

  <p>The attributes <code>windowDrawsSystemBarBackgrounds</code>, <code>colorPrimary</code>, and <code>colorPrimaryDark</code> are only valid for API levels 21 and above. One <code>styles.xml</code> file containing attributes for API 21 and above can be stored at <code>res/values-v21</code> while another <code>styles.xml</code> without them at <code>res/values</code>.</p>

  <h3 id="1-1-1"><a href="#1-1-1"></a>Launch icons for different PPI levels</h3>

  <p>The launch icon should be a set of PNG images with different pixel resolutions. Standard launch icons are about the same size on most screens: approximately 30% of an inch. For a screen that renders 160 pixels as 1 inch the icon size is 30% of 160 pixels—48px.</p>

  <div class="note">
    Android uses dots-per-inch (DPI) for pixels-per-inch (PPI) and they mean the same thing here.
  </div>

  <p>A device's pixel density is returned from <code>AConfiguration_getDensity()</code> as one of the constants defined by Android. <a href="#table-1">Table 1</a> shows all pixel densities along with their launch icon pixel sizes.</p>

  <table id="table-1">
    <caption>Table 1: Android's pixel density constants.</caption>
    <tr><th>Name</th><th>Pixels per inch</th><th>Icon px</th><th>Constant in <code>configuration.h</code></th><th>Scale of mdpi</th></tr>
    <tr><td class="c">ldpi</td><td class="c">120</td><td class="r">36px</td><td class="mono">ACONFIGURATION_DENSITY_LOW</td><td class="c">0.75</td></tr>
    <tr><td class="c">mdpi</td><td class="c">160</td><td class="r">48px</td><td class="mono">ACONFIGURATION_DENSITY_MEDIUM</td><td class="c">1</td></tr>
    <tr><td class="c">tvdpi</td><td class="c">213</td><td class="r">63.9px</td><td class="mono">ACONFIGURATION_DENSITY_TV</td><td class="c">1.33</td></tr>
    <tr><td class="c">hdpi</td><td class="c">240</td><td class="r">72px</td><td class="mono">ACONFIGURATION_DENSITY_HIGH</td><td class="c">1.5</td></tr>
    <tr><td class="c">xhdpi</td><td class="c">320</td><td class="r">96px</td><td class="mono">ACONFIGURATION_DENSITY_XHIGH</td><td class="c">2.0</td></tr>
    <tr><td class="c">xxhdpi</td><td class="c">480</td><td class="r">144px</td><td class="mono">ACONFIGURATION_DENSITY_XXHIGH</td><td class="c">3.0</td></tr>
    <tr><td class="c">xxxhdpi</td><td class="c">640</td><td class="r">192px</td><td class="mono">ACONFIGURATION_DENSITY_XXXHIGH</td><td class="c">4.0</td></tr>
    <tr><td class="c">nodpi</td><td class="c">-1</td><td class="c">-</td><td class="mono">ACONFIGURATION_DENSITY_NONE</td><td class="c">-</td></tr>
    <tr><td class="c">-</td><td class="c">-2</td><td class="c">-</td><td class="mono">ACONFIGURATION_DENSITY_ANY</td><td class="c">-</td></tr>
  </table>

  <p>The icon files, all named <code>ic_launcher.png</code> in this case, are stored in the corresponding <code>mipmap-&lt;DPI&gt;</code> directory within the <code>res</code> directory. <code>&lt;DPI&gt;</code> corresponds to the name in the table, excluding <code>nodpi</code>. For example, <code>mipmap-hdpi</code>. At least <code>ldpi</code> and <code>tvdpi</code> shouldn't be needed; if a particular resolution isn't available the system scales one it can access.</p>
  
</div>

<div>

  <h3 id="1-1-2"><a href="#1-1-2"></a>Build scripts</h3>

  <p>The NDK includes a clang compiler that will use architecture-specific toolchains. The build scripts below compile one shared libraries per architecture and stores them at <code>build\lib\&lt;ARCH&gt;</code>. The four architectures supported here are: 32-bit ARMv7-A, 64-bit ARMv8-A, 32-bit x86, and 64-bit x86-64.</p>

  <p>The libraries must link to <code>libandroid.so</code> for native activity functions. The <code>pthread</code> library is contained within the <code>libc.a</code> library. OpenGL ES 2.0 requires <code>libEGL.so</code> and <code>libGLESv2.so</code>. OpenSL ES requires <code>libOpenSLES.so</code>. The <code>liblog.so</code> library enables logging to the <code>adb.exe</code> debugging tool.</p>

  <p>The paths to shared libraries, static libraries, and assembly files are manually specified when building. The Android headers are in <code>ndk/sysroot/usr/include/android</code> and these include documentation.</p>

  <div class="note">
    Shared libraries: <code>ndk/platforms/android-&lt;API&gt;/&lt;ARCH&gt;/usr/lib</code>. Static libraries: <code>ndk/sysroot/usr/lib/&lt;ARCH&gt;</code>. <code>libgcc.a</code> is automatically linked from the toolchain directory.
    <br><br>
    ABI-specific assembly code is included with <code>-isystem ndk/sysroot/usr/include/&lt;ABI&gt;</code>.
  </div>

  <p>The build scripts in the following sections are Windows command-line batch files. They are based on code found in the NDK <code>build</code> directory. Differences between the scripts are emphasized.</p>

  <div class="note">
    <code>-ffunction-sections -fdata-sections -Wl,--gc-sections</code> removes unused sections. <code>-Wno-unused-function</code> disables the compiler warning of unused functions.
    <br><br>
    <code>clang</code>'s <code>-Oz</code> optimization option should also minimize size, as opposed to <code>-O2</code>. <code>-s</code> removes symbol table and relocation information; the NDK build scripts use <code>strip --strip-unneeded</code> instead.
    <br><br>
    <code>-DDEBUG=1 -Wno-unused-variable</code> are used while developing.
  </div>

  <h4>32-bit ARMv7-A</h4>

  <p>The script <code>build_armeabi-v7a.bat</code> shown below builds for the 32-bit ARMv7-A architecture.</p>

  <div class="code"><pre><code
>@echo off
setlocal

set CC=ndk\toolchains\llvm\prebuilt\windows-x86_64\bin\clang.exe
set OUT=libmylib.so
set SYS_ROOT=ndk/platforms/android-21/<span class="em">arch-arm</span>
set LIB_DIR=%SYS_ROOT%/usr/lib

set FLAGS=-shared <span class="em">-fpic</span> ^
    -target <span class="em">armv7</span>-none-linux-androideabi ^
    <span class="em">-march=armv7-a -mfloat-abi=softfp -mfpu=vfpv3-d16</span> ^
    -gcc-toolchain ndk/toolchains/<span class="em">arm-linux-androideabi-4.9</span>/prebuilt/windows-x86_64 ^
    --sysroot=%SYS_ROOT% ^
    -isystem ndk/sysroot/usr/include -isystem ndk/sysroot/usr/include/<span class="em">arm-linux-androideabi</span> ^
    -nostdlib -L%LIB_DIR% -lgcc -lc -Wl,--exclude-libs,libgcc.a,--exclude-libs,libc.a ^
    -I src -lGLESv2 -lEGL -lOpenSLES -llog -landroid ^
    -Wl,<span class="em">--fix-cortex-a8</span>,-soname,%OUT%,-z,relro,-z,now,-z,noexecstack -Wa,--noexecstack ^
    -Wl,--gc-sections,--no-undefined,--fatal-warnings,--warn-shared-textrel ^
    -Wall -Werror -Wno-unused-function -ffunction-sections -fdata-sections ^
    -fvisibility=hidden -no-canonical-prefixes ^
    -Oz -s -ffast-math -DDEBUG=1 -Wno-unused-variable

call %CC% -o build/lib/<span class="em">armeabi-v7a</span>/%OUT% src/main.c %FLAGS%

endlocal</code></pre>
  </div>

  <p>The compiler defines <code>__arm__</code> when building for 32-bit ARM.</p>

  <p>32-bit ARM defaults to software float instructions. <code>-march=armv7-a</code> generates ARMv7-A code, which only has optional NEON instruction support, so <code>-mfpu=vfpv3-d16</code> is used instead of <code>-mfpu=neon</code>. <code>-mfloat-abi=softfp</code> enables hardware float instructions with the software calling convention.</p>

  <p><code>--fix-cortex-a8</code> is needed to fix a Cortex-A8 CPU bug.</p>

  

</div>

<div>

  <h4>64-bit ARMv8-A</h4>

  <p>The script <code>build_arm64-v8a.bat</code> shown below builds for the 64-bit ARMv8-A architecture.</p>

  <div class="code"><pre><code
>@echo off
setlocal

set CC=ndk\toolchains\llvm\prebuilt\windows-x86_64\bin\clang.exe
set OUT=libmylib.so
set SYS_ROOT=ndk/platforms/android-21/<span class="em">arch-arm64</span>
set LIB_DIR=%SYS_ROOT%/usr/lib

set FLAGS=-shared <span class="em">-fpic</span> ^
    -target <span class="em">aarch64</span>-none-linux-androideabi ^
    -gcc-toolchain ndk/toolchains/<span class="em">aarch64-linux-android-4.9</span>/prebuilt/windows-x86_64 ^
    --sysroot=%SYS_ROOT% ^
    -isystem ndk/sysroot/usr/include -isystem ndk/sysroot/usr/include/<span class="em">aarch64-linux-android</span> ^
    -nostdlib -L%LIB_DIR% -lgcc -lc -Wl,--exclude-libs,libgcc.a,--exclude-libs,libc.a ^
    -I src -lGLESv2 -lEGL -lOpenSLES -llog -landroid ^
    -Wl,-soname,%OUT%,-z,relro,-z,now,-z,noexecstack -Wa,--noexecstack ^
    -Wl,--gc-sections,--no-undefined,--fatal-warnings,--warn-shared-textrel ^
    -Wall -Werror -Wno-unused-function -ffunction-sections -fdata-sections ^
    -fvisibility=hidden -no-canonical-prefixes ^
    -Oz -s -ffast-math -DDEBUG=1 -Wno-unused-variable

call %CC% -o build/lib/<span class="em">arm64-v8a</span>/%OUT% src/main.c %FLAGS%

endlocal</code></pre>
  </div>

  <p>The compiler defines <code>__aarch64__</code> when building for 64-bit ARM.</p>

  <p>All ARMv8-A devices support NEON instructions and will use the hardware floating-point units.</p>

  <h4>32-bit x86</h4>

  <p>The script <code>build_x86.bat</code> shown below builds for the 32-bit x86 architecture.</p>

  <div class="code"><pre><code
>@echo off
setlocal

set CC=ndk\toolchains\llvm\prebuilt\windows-x86_64\bin\clang.exe
set OUT=libmylib.so
set SYS_ROOT=ndk/platforms/android-21/<span class="em">arch-x86</span>
set LIB_DIR=%SYS_ROOT%/usr/lib

set FLAGS=-shared <span class="em">-fPIC -mstackrealign</span> ^
    -target <span class="em">i686</span>-none-linux-androideabi ^
    -gcc-toolchain ndk/toolchains/<span class="em">x86-4.9</span>/prebuilt/windows-x86_64 ^
    --sysroot=%SYS_ROOT% ^
    -isystem ndk/sysroot/usr/include -isystem ndk/sysroot/usr/include/<span class="em">i686-linux-android</span> ^
    -nostdlib -L%LIB_DIR% -lgcc -lc -Wl,--exclude-libs,libgcc.a,--exclude-libs,libc.a ^
    -I src -lGLESv2 -lEGL -lOpenSLES -llog -landroid ^
    -Wl,-soname,%OUT%,-z,relro,-z,now,-z,noexecstack -Wa,--noexecstack ^
    -Wl,--gc-sections,--no-undefined,--fatal-warnings,--warn-shared-textrel ^
    -Wall -Werror -Wno-unused-function -ffunction-sections -fdata-sections ^
    -fvisibility=hidden -no-canonical-prefixes ^
    -Oz -s -ffast-math -DDEBUG=1 -Wno-unused-variable

call %CC% -o build/lib/<span class="em">x86</span>/%OUT% src/main.c %FLAGS%

endlocal</code></pre>
  </div>

  <p>The compiler defines <code>__i386__</code> when building for 32-bit x86.</p>

  <p><code>-mstackrealign</code> fixes a bug in Android x86 devices when the API level is below 24. It should be omitted for API levels equal or greater than 24.</p>

  <h4>64-bit x86-64</h4>

  <p>The script <code>build_x86_64.bat</code> shown below builds for the 32-bit x86-64 architecture.</p>

</div>

<div>

  <div class="code"><pre><code
>@echo off
setlocal

set CC=ndk\toolchains\llvm\prebuilt\windows-x86_64\bin\clang.exe
set OUT=libmylib.so
set SYS_ROOT=%NDK%/platforms/android-21/<span class="em">arch-x86_64</span>
set LIB_DIR=%SYS_ROOT%/usr/lib64

set FLAGS=-shared <span class="em">-fPIC</span> ^
    -target <span class="em">x86_64</span>-none-linux-androideabi ^
    -gcc-toolchain ndk/toolchains/<span class="em">x86_64-4.9</span>/prebuilt/windows-x86_64 ^
    --sysroot=%SYS_ROOT% ^
    -isystem ndk/sysroot/usr/include -isystem ndk/sysroot/usr/include/<span class="em">x86_64-linux-android</span> ^
    -nostdlib -L%LIB_DIR% -lgcc -lc -Wl,--exclude-libs,libgcc.a,--exclude-libs,libc.a ^
    -I src -lGLESv2 -lEGL -lOpenSLES -llog -landroid ^
    -Wl,-soname,%OUT%,-z,relro,-z,now,-z,noexecstack -Wa,--noexecstack ^
    -Wl,--gc-sections,--no-undefined,--fatal-warnings,--warn-shared-textrel ^
    -Wall -Werror -Wno-unused-function -ffunction-sections -fdata-sections ^
    -fvisibility=hidden -no-canonical-prefixes ^
    -Oz -s -ffast-math -DDEBUG=1 -Wno-unused-variable

call %CC% -o build/lib/<span class="em">x86_64</span>/%OUT% src/main.c %FLAGS%

endlocal</code></pre>
  </div>

  <p>The compiler defines <code>__x86_64__</code> when building for 64-bit x86-64.</p>

  <h3 id="1-1-3"><a href="#1-1-3"></a>ADB debugging</h3>

  <p>Android Debug Bridge (<code>ADB</code>) is installed by the SDK manager tool as part of the platform tools. The command <code>adb logcat</code> outputs the log messages sent from a USB-connected device.</p>

  <p>Manufacturer-specific drivers for USB debugging must be installed when on Windows. OEM device drivers can be downloaded at <a href="https://developer.android.com/studio/run/oem-usb#Drivers">developer.android.com/studio/run/oem-usb#Drivers</a> and the Google Nexus driver at <a href="https://developer.android.com/studio/run/win-usb">developer.android.com/studio/run/win-usb</a>. Alternatively download the Nexus device driver with the SDK manager package named <code>extras;google;usb_driver</code>.</p>

  <p>The USB-connected device must have USB debugging enabled which is found under developer options in settings. On Android 4.2 and higher the developer options are only shown after tapping seven times on the build number shown within the "About Phone" view.</p>

  <p>Use <code>adb start-server</code> to start the ADB server and <code>adb kill-server</code> to stop it. A prompt to allow USB debugging should appear on the connected device. Use <code>adb devices -l</code> to list connected devices. Install with <code>adb install -r app.apk</code> and uninstall with <code>adb uninstall &lt;PACKAGE&gt;</code>.</p>

  <p>The following script will install the application, clear the logs and begin outputting <code>logcat</code> messages.</p>

  <div class="code"><pre><code
>set ADB=sdk\platform-tools\adb.exe
call %ADB% install -r app.apk
call %ADB% logcat -c
call %ADB% logcat libc:E APP:V *:S</code></pre>
  </div>

  <h4>logcat</h4>

  <p><code>logcat</code> filters its output on both priority level and tag string. Above, <code>APP</code> is the application's tag string used in <code>__android_log_write()</code> and <code>__android_log_print()</code>; these functions are in the <code>log.h</code> header file. Appending the filter <code>*:S</code> silences all messages except those matching the other filters.</p>

  <p>Segmentation faults and failed assertions are logged with fatal priority and <code>libc</code> as tag.</p>

  <p><a href="#table-2">Table 2</a> lists all the priority levels and corresponding C code constants. The priority increases in descending order. Filtering on a priority level will also include higher priority levels.</p>

  </div>

<div>
  
  <table id="table-2">
    <caption>Table 2: <code>logcat</code> priority levels.</caption>
    <tr><th>Name</th><th>Constant in <code>log.h</code></th><th>Description</th></tr>

    <tr><td class="c">V</td><td>ANDROID_LOG_VERBOSE</td><td>Verbose logging. The lowest priority.</td></tr>
    <tr><td class="c">D</td><td>ANDROID_LOG_DEBUG</td><td>Debug logging.</td></tr>
    <tr><td class="c">I</td><td>ANDROID_LOG_INFO</td><td>Informational logging.</td></tr>
    <tr><td class="c">W</td><td>ANDROID_LOG_WARN</td><td>Warning logging. Used with recoverable failures.</td></tr>
    <tr><td class="c">E</td><td>ANDROID_LOG_ERROR</td><td>Error logging. Used with unrecoverable failures.</td></tr>
    <tr><td class="c">F</td><td>ANDROID_LOG_FATAL</td><td>Fatal logging. Used when aborting.</td></tr>
    <tr><td class="c">S</td><td>ANDROID_LOG_SILENT</td><td>Silent logging. These won't be output.</td></tr>
  </table>

  

  <h2 id="1-2"><a href="#1-2"></a>Native C source code</h2>

  <p>The main thread runs the Android activity code and the application will run as a separate thread. The activity loads the application library and calls <code>ANativeActivity_onCreate()</code>. From there the application thread is started. The main thread will jump into callback functions to deliver activity events to the application.</p>

  <div class="note">
    The callbacks post event messages to the application thread through a block-free circular buffer. A mutex lock and condition variable are used to perform blocking synchronization. Synchronization is needed in callbacks that will destroy resources that the application thread is using.
  </div>

  <p>Below is an implementation for <code>ANativeActivity_onCreate()</code>. The callbacks are attached to the <code>ANativeActivity</code> data structure. This structure is passed to all callbacks as well. The <code>ANativeActivity</code>'s <code>instance</code> member stores application-specific memory space.</p>

  <div class="code"><pre><code
>#include &lt;android/native_activity.h&gt;

JNIEXPORT void
ANativeActivity_onCreate(ANativeActivity* activity, void* savedState, size_t savedStateSize)
{   activity->callbacks->onStart                 = onStart;
    activity->callbacks->onResume                = onResume;
    activity->callbacks->onPause                 = onPause;
    activity->callbacks->onStop                  = onStop;
    activity->callbacks->onDestroy               = onDestroy;
    activity->callbacks->onWindowFocusChanged    = onWindowFocusChanged;
    activity->callbacks->onNativeWindowCreated   = onNativeWindowCreated;
    activity->callbacks->onNativeWindowResized   = onNativeWindowResized;
    activity->callbacks->onNativeWindowDestroyed = onNativeWindowDestroyed;
    activity->callbacks->onNativeWindowRedrawNeeded = onNativeWindowRedrawNeeded;
    activity->callbacks->onContentRectChanged    = onContentRectChanged;
    activity->callbacks->onInputQueueCreated     = onInputQueueCreated;
    activity->callbacks->onInputQueueDestroyed   = onInputQueueDestroyed;
    activity->callbacks->onSaveInstanceState     = onSaveInstanceState;
    activity->callbacks->onConfigurationChanged  = onConfigurationChanged;
    activity->callbacks->onLowMemory             = onLowMemory;

    <span class="comment">// allocate and initialize application data</span>
    struct app_data *arg = activity->instance = malloc(APP_SIZE); <span class="comment">// single block allocation</span>
    init_circular_buffer(&arg->buf, arg->buf_data, MESSAGE_COUNT); <span class="comment">// e.g. MESSAGE_COUNT=32 </span>

    sig_init(&arg->sig); <span class="comment">// synchronization primitives</span>

    arg->activity = activity;
    arg->memory_size = APP_SIZE - sizeof(struct app_data); <span class="comment">// remaining heap size</span>
    arg->savedState = savedState;
    arg->savedStateSize = savedStateSize;

    start_thread(MAIN, arg); <span class="comment">// start thread at function MAIN()</span>
}</code></pre>
  </div>

  <p>In this code a single allocation with <code>malloc()</code> creates the heap memory block used by the application. The size should be adjusted to match the application's memory requirements.</p>

  <div class="note">
    All callbacks don't have to be implemented. Leaving a callback member unassigned will disable it.
  </div>

</div>

<div>

  <p>The <code>app_data</code> structure shown below is passed to the application thread. Its <code>memory</code> member is a flexible array for accessing the rest of the allocated heap memory.</p>

  <div class="code"><pre><code
>struct app_data
{   struct sig_t sig;
    struct circular_buffer buf;
    struct buf_message buf_data[MESSAGE_COUNT];
    ANativeActivity *activity;
    void* savedState;
    size_t savedStateSize;
    uint32_t memory_size; <span class="comment">// size of remaining heap memory</span>
    uintptr memory[]; <span class="comment">// remaining heap memory</span>
};</code></pre>
  </div>

  <p><code>start_thread()</code> starts a new detached pthread.</p>

  <div class="code"><pre><code
>static void
start_thread(void* (*thread_proc)(void*), void *arg)
{   pthread_attr_t attr; 
    int ret = pthread_attr_init(&attr); assert(ret==0);
    ret = pthread_attr_setdetachstate(&attr, PTHREAD_CREATE_DETACHED); assert(ret==0);
    pthread_t thread_id; <span class="comment">// ignored</span>
    ret = pthread_create(&thread_id, &attr, thread_proc, arg); assert(ret==0);
    ret = pthread_attr_destroy(&attr); assert(ret==0);
}</code></pre>
  </div>

  <p>The <code>MAIN()</code> function is shown below. It intializes its own <code>application</code> structure and uses a <code>memory_stack</code> data structure to manage the heap block allocation as a stack of bytes.</p>

  <div class="code"><pre><code
>static void*
MAIN(void *argument)
{   struct app_data *arg = argument;
    ANativeActivity *activity = arg->activity;
    <span class="comment">// initialize heap block memory management (uses PUSH and POP to "allocate"/"deallocate")</span>
    struct memory_stack *stack = (struct memory_stack*)(arg->memory[0]);
    init_memory_stack(stack, stack, arg->memory_size); <span class="comment">construct at beginning of memory block</span>
    PUSH(stack, sizeof(struct memory_stack)); <span class="comment">// mark as allocated for stack struct</span>

    struct application *app = PUSH_ALIGNED(
        stack, sizeof(struct application), ALIGN_OF(struct application));
    app->stack = stack;
    app->buf = &arg->buf;
    app->input_queue = NULL;
    app->has_focus = 0;
    app->is_paused = 1;
    app->is_stopped = 1;
    app->is_fullscreen = 0;
    <span class="comment">// application-specific initialization</span>
    init_save_state(stack, app, activity, arg->savedState, arg->savedStateSize);
    init_input(stack, &app->input);
    init_graphics(stack, &app->graphics);
    init_audio(stack, &app->audio);

    struct buf_message message; <span class="comment">// receives message from main thread</span>
    for (;;) <span class="comment">// main loop</span>
    {   if (app->input_queue) <span class="comment">// input_queue is received from native callback message</span>
        {   process_input(app); <span class="comment">// receive input events</span>
            ... <span class="comment">// interpret input</span>
        }
        while (buf_read(app->buf, &message)) <span class="comment">// receive native callback messages</span>
        {   switch (message.data0) <span class="comment">// switch on message type</span>
            {   case START: ...
            }
        }

        ... <span class="comment">// do application work...</span>

        if (!app->is_paused) <span class="comment">// after the "resume" callback</span>
        {   if (app->has_focus) <span class="comment">// after the "focus gained" callback</span>
            {   ... <span class="comment">// render</span>
            }
        }
        sleep(...); <span class="comment">// sleep to pace the frame rate</span>
    }
    return NULL;
}</code></pre>
  </div>

  </div>

<div>

  <p>The callback and <code>onCreate()</code> function signatures are declared in the <code>native_activity</code> header file. All the signatures are shown below.</p>

  <div class="code"><pre><code
><span class="comment">// NativeActivity has launched.</span>
void ANativeActivity_onCreate(ANativeActivity* activity, void* savedState, size_t savedStateSize);

<span class="comment">// NativeActivity has started; the application isn't in foreground yet.</span>
void onStart(ANativeActivity* activity);

<span class="comment">// NativeActivity has resumed; the application is in foreground.</span>
void onResume(ANativeActivity* activity);

<span class="comment">// NativeActivity has paused; the application lost its foreground state.</span>
void onPause(ANativeActivity* activity);

<span class="comment">// NativeActivity has stopped; the process can be killed.</span>
void onStop(ANativeActivity* activity);

<span class="comment">// NativeActivity is being destroyed.</span>
void onDestroy(ANativeActivity* activity);

<span class="comment">// NativeActivity is being asked to save its current instance state.</span>
void* onSaveInstanceState(ANativeActivity* activity, size_t* outLen);

<span class="comment">// NativeActivity's window has gained or lost focus.</span>
void onWindowFocusChanged(ANativeActivity* activity, int hasFocus);

<span class="comment">// NativeActivity's window has been created.</span>
void onNativeWindowCreated(ANativeActivity* activity, ANativeWindow* window);

<span class="comment">// NativeActivity's window changed size.</span>
void onNativeWindowResized(ANativeActivity* activity, ANativeWindow* window);

<span class="comment">// NativeActivity's window is being destroyed.</span>
void onNativeWindowDestroyed(ANativeActivity* activity, ANativeWindow* window);

<span class="comment">// the window content rectangle has changed.</span>
void onContentRectChanged(ANativeActivity* activity, const ARect* rect);

<span class="comment">// NativeActivity's input queue has been created</span>
void onInputQueueCreated(ANativeActivity* activity, AInputQueue* queue);

<span class="comment">// NativeActivity's input queue is being destroyed.</span>
void onInputQueueDestroyed(ANativeActivity* activity, AInputQueue* queue);

<span class="comment">// Device's configuration has changed</span>
void onConfigurationChanged(ANativeActivity* activity);

<span class="comment">// NativeActivity's window callback for dirty regions.</span>
void onNativeWindowRedrawNeeded(ANativeActivity* activity, ANativeWindow* window);

<span class="comment">// The system is running low on memory.</span>
void onLowMemory(ANativeActivity* activity);</code></pre>
  </div>

  <p>When a callback only needs to notify the application of an event without synchronization it sends a message with the event type without blocking on a condition variable. A callback can attach more data to the message as <code>onNativeWindowCreated()</code> does below.</p>

  <div class="code"><pre><code
>static void
onNativeWindowCreated(ANativeActivity* activity, ANativeWindow* window)
{   struct buf_message message = { WINDOW_CREATED, (uintptr)window };
    struct app_data *a = activity->instance;
    while (0 != buf_write(&a->buf, &message))
        ;
}</code></pre>
  </div>

  <p>When a callback needs to wait until the message arrives, it sends the message with a pointer to the synchronization primitive and then calls <code>sig_wait()</code>. For example, as in <code>onStop()</code> as shown below.</p>

  <div class="code"><pre><code
>static void
onStop(ANativeActivity* activity)
{   struct app_data *a = activity->instance;
    struct buf_message message = { STOP, (uintptr)&a->sig };
    while (0 != buf_write(&a->buf, &message))
        ;
    sig_wait(&a->sig);
}</code></pre>
  </div>

</div>

<div>

  <h3 id="1-2-1"><a href="#1-2-1"></a>Circular buffer and synchronization</h3>

  <p>The circular buffer has a single reader and a single writer; the main thread writes to the circular buffer and the application thread reads from it. <a href="#figure-2">Figure 2</a> illustrates the circular buffer structure.</p>

  <figure aria-labelledby="figure-2-caption" id="figure-2">
<pre role="img"
>
                Four unread:             Buffer empty:            Buffer full:
                ┌─┬─┬─┬─┬─┬─┬─┬─┐        ┌─┬─┬─┬─┬─┬─┬─┬─┐        ┌─┬─┬─┬─┬─┬─┬─┬─┐
                │  x x x x      │        │               │        │x x x x   x x x│
                └─┴┬┴─┴─┴─┴┬┴─┴─┘        └─┴─┴─┴─┴─┴┬┴─┴─┘        └─┴─┴─┴─┴┬┴┬┴─┴─┘
                   R       W                       R/W                     W R</pre>
  <figcaption id="figure-2-caption">Figure 2: The circular buffer structure. The writer and reader positions wrap around at the end. The buffer is empty when R=W and the buffer is full when R=W+1. When full, one slot is wasted because the writer can't advance; the buffer should be large enough to never become full.</figcaption>
  </figure>

  <p>Messages are fixed size. This simplifies the implementation, but it wastes memory and computation time. The buffer capacity must be a power of two to wrap the positions using a bit operation. The circular buffer structure definition and initialization function are shown below.</p>

  <div class="code"><pre><code
>struct buf_message
{   uintptr data0; <span class="comment">// message type</span>
    uintptr data1; <span class="comment">// struct sig_t *sig or data</span>
    uintptr data2; <span class="comment">// data</span>
    uintptr data3; <span class="comment">// more data</span>
};
struct circular_buffer
{   struct buf_message *data; <span class="comment">// allocated buffer memory</span>
    uint32 hi; <span class="comment">// writer position</span>
    uint32 lo; <span class="comment">// reader position</span>
    uint32 capacity; <span class="comment">// number of messages</span>
};

static void
init_circular_buffer(struct circular_buffer* buf, void *memory, uint32 capacity_count)
{   assert(memory == ALIGN(memory, ALIGN_OF(struct buf_message))); <span class="comment">// check alignment</span>
    assert((capacity_count & (capacity_count - 1)) == 0); <span class="comment">// check power of two</span>
    buf->data = memory;
    buf->hi = 0;
    buf->lo = 0; 
    buf->capacity = capacity_count;
}</code></pre>
  </div>

  <p>The writer and reader thread must perform their memory access instructions such that their positions aren't seen as incremented before they are done with a message. That means the following things.</p>

  <ul>
    <li>The writer must finish writing the message before allowing it to be read.</li>
    <li>The reader mustn't load the message before loading the writer position.</li>
    <li>The reader must copy the message before allowing it to be overwritten.</li>
    <li>The writer mustn't write the message before loading the reader position.</li>
    <li>The compiler mustn't optimize away loads of the other thread's position.</li>
  </ul>

  <p>Thus, when a thread is done with a message it inserts a memory fence before storing its new position, and when a thread loads the other's position it inserts a memory fence before accessing the message.</p>

  <p>The <code>__ATOMIC_ACQUIRE</code> fence ensures memory loads are issued before all memory accesses after it. The <code>__ATOMIC_RELEASE</code> fence ensures memory stores are issued after all memory accesses before it.</p>

  <p>The compiler intrinsics <code>__atomic_store_n()</code> and <code>__atomic_load_n()</code> are used instead of the explicit <code>__atomic_thread_fence()</code> because they more granularly order a specific memory access.</p>

  <div class="note">
    A memory fence implies a compiler fence (i.e. <code>asm volatile("" ::: "memory")</code>) which stops the compiler from removing memory accesses unnecessary in single-threaded code. This could otherwise have been a problem if the functions were inlined.
  </div>

</div>

<div>

  <p>The writer uses <code>buf_write()</code> and the reader uses <code>buf_read()</code>. These are shown below.</p>

  <div class="code"><pre><code
>static int
buf_write(struct circular_buffer *buf, struct buf_message *msg)
{   int result = 0;
    uint32 hi = buf->hi;
    uint32 next = (hi+1) & (buf->capacity-1);
    uint32 lo = __atomic_load_n(&buf->lo, __ATOMIC_ACQUIRE);
    <span class="comment">// load lo is before store out->data</span>
    if (next != lo)
    {   struct buf_message *out = buf->data + hi;
        out->data0 = msg->data0;
        out->data1 = msg->data1;
        out->data2 = msg->data2;
        out->data3 = msg->data3;
        <span class="comment">// store out->data is before store buf->hi</span>
        __atomic_store_n(&buf->hi, next, __ATOMIC_RELEASE);
        result = 1; <span class="comment">// success</span>
    }
    return result;
}

static int
buf_read(struct circular_buffer *buf, struct buf_message *out)
{   int result = 0;
    uint32 lo = buf->lo;
    uint32 hi = __atomic_load_n(&buf->hi, __ATOMIC_ACQUIRE);
    <span class="comment">// load hi is before load msg->data</span>
    if (lo != hi)
    {   struct buf_message *msg = buf->data + lo;
        out->data0 = msg->data0;
        out->data1 = msg->data1;
        out->data2 = msg->data2;
        out->data3 = msg->data3;
        <span class="comment">// load msg->data is before store buf->lo</span>
        __atomic_store_n(&buf->lo, (lo+1) & (buf->capacity-1), __ATOMIC_RELEASE);
        result = 1; <span class="comment">// success</span>
    }
    return result;
}</code></pre>
  </div>


  <p>On ARMv7-A, the compiler outputs <code>dmb ish</code> instructions to synchronize memory accesses. It doesn't output these on ARMv8-A. The x86 and x86-64 architectures have a strong memory model and can only re-order loads to before stores.</p>

  <div class="note">
    The NDK toolchains include the <code>objdump</code> tool at <code>ndk\toolchains\&lt;ABI&gt;-4.9\prebuilt\windows-x86_64\&lt;ABI&gt;\bin\objdump.exe</code> which can output the dissambly using:<br>
    <code>objdump --disassemble --line-numbers build\lib\&lt;ARCH&gt;\libmylib.so</code><br>
    The libraries should be compiled without <code>-s</code> to not strip the symbol table.
  </div>

  <h4>Synchronization with condition variable</h4>

  <p>The main thread can block until the application thread un-blocks it by using the circular buffer to send a pointer to a synchronization primitive. This requires a mutex lock, a condition variable, and a condition flag. These are packaged in the <code>sig_t</code> structure shown below.</p>

  <div class="code"><pre><code
>struct sig_t
{   uint32_t condition;
    pthread_mutex_t lock; <span class="comment">// mutual exclusion on the condition flag</span>
    pthread_cond_t cond;
};

static void
sig_init(struct sig_t *sig)
{   int ret = pthread_cond_init(&sig->cond, NULL); assert(ret==0);
    ret = pthread_mutex_init(&sig->lock, NULL); assert(ret==0);
}
static void
sig_destroy(struct sig_t *sig)
{   int ret = pthread_cond_destroy(&sig->cond); assert(ret==0);
    ret = pthread_mutex_destroy(&sig->lock); assert(ret==0);
}</code></pre>
  </div>

  <p>The main thread calls the <code>sig_wait()</code> function shown below after sending the message. <code>sig_wait()</code> un-sets the condition flag and therefore the main thread can re-use the function multiple times.</p>

</div>

<div>

  <div class="code"><pre><code
>static void
sig_wait(struct sig_t *sig)
{   int ret = pthread_mutex_lock(&sig->lock); assert(ret==0);
    while (!sig->condition)
    {   ret = pthread_cond_wait(&sig->cond, &sig->lock); assert(ret==0);
    }
    sig->condition = 0;
    ret = pthread_mutex_unlock(&sig->lock); assert(ret==0);
}</code></pre>
  </div>

  <p>The application thread calls the <code>sig_signal()</code> function shown below after receiving the message.</p>

  <div class="code"><pre><code
>static void
sig_signal(struct sig_t *sig)
{   int ret = pthread_mutex_lock(&sig->lock); assert(ret==0);
    sig->condition = 1;
    ret = pthread_mutex_unlock(&sig->lock); assert(ret==0);
    ret = pthread_cond_signal(&sig->cond); assert(ret==0);
}</code></pre>
  </div>

  <p>The <code>onInputQueueDestroyed()</code> callback uses <code>sig_wait()</code> because it must wait until the application thread stops using the <code>AInputQueue</code> object before returning. Its implementation is below.</p>


  <div class="code"><pre><code
>static void
onInputQueueDestroyed(ANativeActivity* activity, AInputQueue* queue)
{   struct app_data *a = activity->instance;
    struct buf_message message = { INPUT_QUEUE_DESTROYED, (uintptr)&a->sig, (uintptr)queue, 0 };
    while(!buf_write(&a->buf, &message))
        ;
    sig_wait(&a->sig);
}</code></pre>
  </div>

  <p>The application thread receives the <code>INPUT_QUEUE_DESTROYED</code> message and calls <code>sig_signal()</code>.</p>

  <div class="code"><pre><code
>switch (message.data0)
{   ...
    case INPUT_QUEUE_DESTROYED:
    {   app->input_queue = NULL;
        struct sig_t *sig = (struct sig_t*)message.data1;
        sig_signal(sig);
    } break;
    ...</code></pre>
  </div>

  <h3 id="1-2-2"><a href="#1-2-2"></a>Android activity life cycle events and state changes</h3>

  <p>The native activity is the only activity in the application and its life cycle events occur concurrently with other state changes. Only some events are dependent on others as shown in <a href="#figure-3">figure 3</a>.</p>

  <figure aria-labelledby="figure-3-caption" id="figure-3">
<pre role="img"
> ┌>Create ────────────────┬─────────────┬──────────────┬────────────┬───────────────┐
 ├>Start                  v             v              v            v               v
 │ Resume<┐          ┌>FocusGain ┌>WindowCreate ┌>ContentRect ┌>InputCreate  ┌>ConfigChange
 │ Pause ─┴─v        └ FocusLost │ WindowResize └──┘          └ InputDestroy └──┘
 ├ Stop    SaveState             │ Redraw
 └ Destroy                       └ WindowDestroy</pre>
  <figcaption id="figure-3-caption">Figure 3: Sequencing of events. Events happen downwards and along the arrows, independently of other columns. <code>LowMemory</code> is left out, but like <code>ContentRect</code> and <code>ConfigChange</code> it's dependent only on <code>Create</code>. Note that focus changes and <code>ContentRect</code> events can come before or after <code>WindowDestroy</code> and <code>Stop</code>.</figcaption>
  </figure>

  <p>The activity launches into <code>ANativeActivity_onCreate()</code>. The <code>Start</code> and <code>Resume</code> events arrive shortly after that. <code>Pause</code> happens upon moving away from the foreground. Then, either <code>Resume</code> or <code>Stop</code> is sent. After <code>Stop</code> the activity may receive <code>Destroy</code>, <code>Start</code>, or <code>Create</code> once again.</p>

  <p><a href="#table-3">Table 3</a> lists all the events and describes event handling based on the event's basic intent.</p>

</div>

<div>

  <table id="table-3">
    <caption>Table 3: Native activity event handling.</caption>
    <tr>
      <th>Event</th><th>Native callback</th><th>Handling</th>
    </tr>
    <tr>
      <td class="c mono">Create</td>
      <td class="l w mono">void<br>ANativeActivity_onCreate<br>(ANativeActivity*,void*,size_t)</td>
      <td class="l">Entry point that starts application thread. The saved state is passed; it may be <code>NULL</code>. Don't call <code>free()</code> on the pointer.</td>
    </tr>
    <tr>
      <td class="c mono">Start</td>
      <td class="l w mono">void<br>onStart<br>(ANativeActivity*)</td>
      <td class="l">Starting from a stopped state. Recreate any resources destroyed in <code>Stop</code>.</td>
    </tr>
    <tr>
      <td class="c mono">Resume</td>
      <td class="l w mono">void<br>onResume<br>(ANativeActivity*)</td>
      <td class="l">Resuming from a paused state. Wait for <code>FocusGain</code> before rendering again because the device may be at the lock screen.</td>
    </tr>
    <tr>
      <td class="c mono">Pause</td>
      <td class="l w mono">void<br>onPause<br>(ANativeActivity*)</td>
      <td class="l">The application is not in the foreground. In a multi-window mode, it may still be visible.</td>
    </tr>
    <tr>
      <td class="c mono">Stop</td>
      <td class="l w mono">void<br>onStop<br>(ANativeActivity*)</td>
      <td class="l">No longer visible, but may be kept in the background as long as there's memory. Free up memory by destroying unneeded resources; e.g. the OpenGL context.</td>
    </tr>
    <tr>
      <td class="c mono">Destroy</td>
      <td class="l w mono">void<br>onDestroy<br>(ANativeActivity*)</td>
      <td class="l">Activity is being destroyed. This may not be sent when the process is being killed.</td>
    </tr>
    <tr>
      <td class="c mono">SaveState</td>
      <td class="l w mono">void*<br>onSaveInstanceState<br>(ANativeActivity*,size_t*)</td>
      <td class="l">Return pointer created with malloc(); the framework calls free(). Set outSize to the allocation size. It should be "small".</td>
    </tr>
    <tr>
      <td class="c mono">FocusGain</td>
      <td class="l w mono">void<br>onWindowFocusChanged<br>(ANativeActivity*,int /*true*/)</td>
      <td class="l">Input focus is gained. Appropriate to start rendering if there's a window. Can occur before or after <code>WindowCreate</code>.</td>
    </tr>
    <tr>
      <td class="c mono">FocusLost</td>
      <td class="l w mono">void<br>onWindowFocusChanged<br>(ANativeActivity*,int /*false*/)</td>
      <td class="l">Input focus is lost. Appropriate to stop rendering. Can be delayed to after <code>Resume</code> when resuming after the screen blacks out. A <code>FocusGain</code> would then immediately follow.</td>
    </tr>
    <tr>
      <td class="c mono">WindowCreate</td>
      <td class="l w mono">void<br>onNativeWindowCreated<br>(ANativeActivity*,ANativeWindow*)</td>
      <td class="l">The window resource is passed to the application.</td>
    </tr>
    <tr>
      <td class="c mono">WindowResize</td>
      <td class="l w mono">void<br>onNativeWindowResized<br>(ANativeActivity*,ANativeWindow*)</td>
      <td class="l">Query the window's dimensions, though they may not have changed. A zero width and height is possible. The EGL surface's update lags behind the window's.</td>
    </tr>
    <tr>
      <td class="c mono">WindowDestroy</td>
      <td class="l w mono">void<br>onNativeWindowDestroyed<br>(ANativeActivity*,ANativeWindow*)</td>
      <td class="l">Block the callback until the application stops using the window resource.</td>
    </tr>
    <tr>
      <td class="c mono">ContentRect</td>
      <td class="l w mono">void<br>onContentRectChanged<br>(ANativeActivity*,const ARect*)</td>
      <td class="l">The rectangle in the window excluding system bars and window decoration has changed. The window probably exists.</td>
    </tr>
    <tr>
      <td class="c mono">InputCreate</td>
      <td class="l w mono">void<br>onInputQueueCreated<br>(ANativeActivity*,AInputQueue*)</td>
      <td class="l">The input queue resource is passed to the application.</td>
    </tr>
    <tr>
      <td class="c mono">InputDestroy</td>
      <td class="l w mono">void<br>onInputQueueDestroyed<br>(ANativeActivity*,AInputQueue*)</td>
      <td class="l">Block the callback until the application stops using the input queue resource.</td>
    </tr>
    <tr>
      <td class="c mono">ConfigChange</td>
      <td class="l w mono">void<br>onConfigurationChanged<br>(ANativeActivity*)</td>
      <td class="l">Screen orientation, DPI, keyboard, language etc. may have changed and should be queried again.</td>
    </tr>
    <tr>
      <td class="c mono">Redraw</td>
      <td class="l w mono">void<br>onNativeWindowRedrawNeeded<br>(ANativeActivity*,ANativeWindow*)</td>
      <td class="l">Window has changed and contents should be re-drawn before callback returns. Only useful for callback-based rendering.</td>
    </tr>
    <tr>
      <td class="c mono">LowMemory</td>
      <td class="l w mono">void<br>onLowMemory<br>(ANativeActivity*)</td>
      <td class="l">Processes are being killed because of memory constraints. May not be sent.</td>
    </tr>
  </table>

  <p>Calling <code>ANativeActivity_finish()</code> initiates the shutdown sequence ending with <code>Destroy</code>.</p>

</div>

</div><!--[ PAGES END ]-->
<div id="footer" class="remove-on-print"><span>2021, Linda Jansson.</span></div>


<!--[ SIDE PANEL ]-->
<input type="checkbox" id="side-panel-switch" aria-hidden="true">
<div id="side-panel" class="remove-on-print">
  <label id="side-panel-icon" for="side-panel-switch" aria-label="side panel toggle"></label>
  <div id="tabs" class="pack16">

    <input type="radio" id="tab-1" name="tab-control" aria-hidden="true" checked>
    <input type="radio" id="tab-2" name="tab-control" aria-hidden="true">
    <input type="radio" id="tab-3" name="tab-control" aria-hidden="true">
    <input type="radio" id="tab-4" name="tab-control" aria-hidden="true">

    <label for="tab-1" class="four" aria-label="side panel outline button">outline</label>
    <label for="tab-2" class="four" aria-label="side panel external button">external</label>
    <label for="tab-3" class="four" aria-label="side panel more button">more</label>
    <label for="tab-4" class="four" aria-label="side panel about button">about</label>

    <div class="sixteen" id="outline-tab">
      <a href="#title">Android NDK programming in C</a>
      <ul>
        <li><a href="#1-1">Compiling an APK</a>
          <ul>
            <li><a href="#1-1-1">Launch icons for different PPI levels</a></li>
            <li><a href="#1-1-2">Build scripts</a></li>
            <li><a href="#1-1-3">ADB debugging</a></li>
          </ul>
        </li>
        <li><a href="#1-2">Native C source code</a>
          <ul>
            <li><a href="#1-2-1">Circular buffer and synchronization</a></li>
            <li><a href="#1-2-2">Android activity life cycle events and state changes</a></li>
          </ul>
        </li>
      </ul>
    </div>
    
    <div class="sixteen" id="reference-tab">
      <div class="reference pack16">
        <div class="two"></div><div class="fourteen em">Android NDK downloads, documentation, and guides.</div>
        <div class="four">Title:</div><div class="twelve">Android NDK | Android Developers</div>
        <div class="four">Author:</div><div class="twelve">Google, Android Open Source Project</div>
        <div class="four">Version:</div><div class="twelve">Accessed 2019-08</div>
        <div class="four">Link:</div><div class="twelve"><a href="https://developer.android.com/ndk">developer.android.com/ndk</a></div>
      </div>
      <div class="reference pack16">
        <div class="two"></div><div class="fourteen em">Android SDK and Android Studio downloads.</div>
        <div class="four">Title:</div><div class="twelve">Download Android Studio and SDK tools | Android Studio | Android Developers</div>
        <div class="four">Author:</div><div class="twelve">Google, Android Open Source Project</div>
        <div class="four">Version:</div><div class="twelve">Accessed 2019-08</div>
        <div class="four">Link:</div><div class="twelve"><a href="https://developer.android.com/studio/#downloads">developer.android.com/studio/#downloads</a></div>
      </div>
      <div class="reference pack16">
        <div class="two"></div><div class="fourteen em">Android command-line tools documentation.</div>
        <div class="four">Title:</div><div class="twelve">Android developers user guide: Command line tools</div>
        <div class="four">Author:</div><div class="twelve">Google, Android Open Source Project</div>
        <div class="four">Version:</div><div class="twelve">Accessed 2019-08</div>
        <div class="four">Link:</div><div class="twelve"><a href="https://developer.android.com/studio/command-line">developer.android.com/studio/command-line</a></div>
      </div>
      <div class="reference pack16">
        <div class="two"></div><div class="fourteen em">AndroidManifest.xml documentation.</div>
        <div class="four">Title:</div><div class="twelve">App Manifest Overview | Android Developers</div>
        <div class="four">Author:</div><div class="twelve">Google, Android Open Source Project</div>
        <div class="four">Version:</div><div class="twelve">Accessed 2019-08</div>
        <div class="four">Link:</div><div class="twelve"><a href="https://developer.android.com/guide/topics/manifest/manifest-intro">developer.android.com/guide/topics/manifest/manifest-intro</a></div>
      </div>
      <div class="reference pack16">
        <div class="two"></div><div class="fourteen em">Activity theme style documentation.</div>
        <div class="four">Title:</div><div class="twelve">R.attr | Android Developers</div>
        <div class="four">Author:</div><div class="twelve">Google, Android Open Source Project</div>
        <div class="four">Version:</div><div class="twelve">Accessed 2019-08</div>
        <div class="four">Link:</div><div class="twelve"><a href="https://developer.android.com/reference/android/R.attr.html">developer.android.com/reference/android/R.attr</a></div>
      </div>
      <div class="reference pack16">
        <div class="two"></div><div class="fourteen em">Pixel density metrics for different devices.</div>
        <div class="four">Title:</div><div class="twelve">Device Metrics - Material Design</div>
        <div class="four">Author:</div><div class="twelve">Google</div>
        <div class="four">Version:</div><div class="twelve">2019-08-13</div>
        <div class="four">Link:</div><div class="twelve"><a href="https://material.io/resources/devices/">material.io/resources/devices/</a></div>
      </div>
      <div class="reference pack16">
        <div class="two"></div><div class="fourteen em">GCC command-line options documentation.</div>
        <div class="four">Title:</div><div class="twelve">GCC Command Options</div>
        <div class="four">Author:</div><div class="twelve">Free Software Foundation, Inc.</div>
        <div class="four">Version:</div><div class="twelve">Accessed 2019-08</div>
        <div class="four">Link:</div><div class="twelve"><a href="https://gcc.gnu.org/onlinedocs/gcc/Invoking-GCC.html">gcc.gnu.org/onlinedocs/gcc/Invoking-GCC.html</a></div>
      </div>
      <div class="reference pack16">
        <div class="two"></div><div class="fourteen em">Acquire and release semantics for memory fences.</div>
        <div class="four">Title:</div><div class="twelve">Acquire and Release Semantics</div>
        <div class="four">Author:</div><div class="twelve">Jeff Preshing</div>
        <div class="four">Version:</div><div class="twelve">2012-09-13</div>
        <div class="four">Link:</div><div class="twelve"><a href="https://preshing.com/20120913/acquire-and-release-semantics/">preshing.com/20120913/acquire-and-release-semantics/</a></div>
      </div>
      <div class="reference pack16">
        <div class="two"></div><div class="fourteen em">Guide to Android life cycle events and state changes.</div>
        <div class="four">Title:</div><div class="twelve">Android Lifecycle for application developers: Guidelines and Tips</div>
        <div class="four">Author:</div><div class="twelve">NVIDIA Corporation</div>
        <div class="four">Version:</div><div class="twelve">2012-05</div>
        <div class="four">Link:</div><div class="twelve"><a href="http://developer.download.nvidia.com/assets/mobile/docs/android_lifecycle_app_note.pdf">developer.download.nvidia.com/assets/mobile/docs/android_lifecycle_app_note.pdf</a></div>
      </div>
      <div class="reference pack16">
        <div class="two"></div><div class="fourteen em">Android life cycle events documentation.</div>
        <div class="four">Title:</div><div class="twelve">Understand the Activity Lifecycle | Android Developers</div>
        <div class="four">Author:</div><div class="twelve">Google, Android Open Source Project</div>
        <div class="four">Version:</div><div class="twelve">Accessed 2019-08</div>
        <div class="four">Link:</div><div class="twelve"><a href="https://developer.android.com/guide/components/activities/activity-lifecycle">developer.android.com/guide/components/activities/activity-lifecycle</a></div>
      </div>
    </div>

    <div id="more-tab">
      <span role="img" aria-label="warning icon" class="icon">⚠</span>
    </div>

    <div id="about-tab">
      <p>This text was written for learning purposes. The website's text, HTML, and CSS were created by Linda Jansson.</p>
      <p>The goal of this text was to organize my notes into a comprehensive format so as to make it more available to others—and myself.</p>
      <p>Notify me of issues at <a href="https://github.com/linjan2/linjan2.github.io">github.com/linjan2/linjan2.github.io</a>.</p>
    </div>

  </div>
</div>

</body>
</html>
